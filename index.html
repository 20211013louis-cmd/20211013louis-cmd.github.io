<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µé€Ÿå•ç­”æŒ‘æˆ°</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --success: #00b894;
            --danger: #d63031;
            --bg: #f0f2f5;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        #game-container {
            background: white;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        /* é€²åº¦æ¢ */
        #timer-bar-container {
            width: 100%;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        #timer-bar {
            width: 100%;
            height: 100%;
            background: var(--primary);
            transition: width 0.1s linear;
        }

        .hidden {
            display: none;
        }

        h2 {
            margin-top: 0;
            color: #2d3436;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .option-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #eee;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .option-btn:hover {
            border-color: var(--secondary);
            background: #f9f9ff;
        }

        .option-btn.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .option-btn.wrong {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        #score-display {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .start-btn {
            padding: 15px 40px;
            font-size: 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>

    <div id="game-container">
        <div id="start-screen">
            <h1>âš¡ æ¥µé€Ÿå•ç­” âš¡</h1>
            <p>ç­”é¡Œè¶Šå¿«ï¼Œåˆ†æ•¸è¶Šé«˜ï¼</p>

            <div id="lobby-ui"
                style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                <div id="connection-status" style="margin-bottom: 15px; font-weight: bold; color: #636e72;">å–®æ©Ÿæ¨¡å¼</div>

                <div id="host-controls">
                    <button class="option-btn" onclick="initHost()"
                        style="background:var(--secondary); color:#fff; border:none;">ğŸ  å»ºç«‹æˆ¿é–“ (ç”¢ç”Ÿé‚€è«‹ç¢¼)</button>
                    <div id="invite-code-display" class="hidden"
                        style="margin-top:10px; padding:10px; background:#e1ffc7; border-radius:5px; font-weight:bold;">
                        é‚€è«‹ç¢¼: <span id="my-peer-id" style="color:#d63031; font-size:1.2em; user-select: all;">...</span>
                    </div>
                </div>

                <div id="join-controls" style="margin-top: 10px;">
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="target-peer-id" placeholder="è¼¸å…¥é‚€è«‹ç¢¼"
                            style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;">
                        <button class="option-btn" onclick="joinGame()"
                            style="width: auto; margin:0; background: #00b894; color: white;">åŠ å…¥</button>
                    </div>
                </div>
            </div>

            <button class="start-btn" id="start-game-btn" onclick="tryStartGame()">é–‹å§‹æŒ‘æˆ°</button>
            <div style="margin-top: 20px;">
                <a href="admin.html" style="color: #999; text-decoration: none; font-size: 14px;">âš™ï¸ ç®¡ç†é¡Œåº«</a>
            </div>
        </div>

        <div id="quiz-screen" class="hidden">
            <div id="header-row"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div id="question-info" style="font-weight: bold;">ç¬¬ <span id="current-idx">1</span> é¡Œ</div>
                <div id="live-score" style="color: var(--primary); font-weight: bold;">ç›®å‰åˆ†æ•¸ï¼š0</div>
            </div>
            <div id="timer-bar-container">
                <div id="timer-bar"></div>
            </div>
            <div id="img-container" style="text-align: center; margin: 10px 0; min-height: 0px;"></div>
            <h2 id="question-text">è¼‰å…¥ä¸­...</h2>
            <div id="options-container"></div>
            <div id="waiting-msg" class="hidden"
                style="margin-top:10px; color:#e17055; font-weight:bold; animation: blink 1s infinite;">ç­‰å¾…å°æ‰‹å›ç­”...</div>
        </div>

        <div id="result-screen" class="hidden">
            <h2>ğŸ† æŒ‘æˆ°çµæŸï¼</h2>
            <div id="score-display">å¾—åˆ†ï¼š0</div>

            <!-- Ranking Section -->
            <div id="ranking-container" class="hidden"
                style="margin-bottom:20px; text-align:left; background:#f0f2f5; padding:15px; border-radius:10px;">
                <h3 style="margin-top:0; text-align:center;">æ’è¡Œæ¦œ</h3>
                <div id="rank-list"></div>
            </div>

            <button class="start-btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        const defaultQuestions = [
            { q: "å°ç£æœ€é«˜çš„å±±æ˜¯å“ªä¸€åº§ï¼Ÿ", a: ["ç‰å±±", "é›ªå±±", "å¤§éœ¸å°–å±±", "é˜¿é‡Œå±±"], correct: 0 },
            { q: "HTML ä¸­å“ªå€‹æ¨™ç±¤æ˜¯ç”¨ä¾†é€£çµ JavaScriptï¼Ÿ", a: ["<link>", "<js>", "<script>", "<href>"], correct: 2 },
            { q: "å¤ªé™½ç³»ä¸­é«”ç©æœ€å¤§çš„è¡Œæ˜Ÿæ˜¯ï¼Ÿ", a: ["åœ°çƒ", "ç«æ˜Ÿ", "æœ¨æ˜Ÿ", "åœŸæ˜Ÿ"], correct: 2 },
            { q: "éŠæˆ²é–‹ç™¼ä¸­ï¼ŒNPC ä»£è¡¨ä»€éº¼ï¼Ÿ", a: ["æ–°ç©å®¶è§’è‰²", "éç©å®¶è§’è‰²", "ä¸»è¦é ˜è¢–è§’è‰²", "æ ¸èƒ½ä¸­å¿ƒ"], correct: 1 }
        ];

        // å„ªå…ˆè®€å– localStorage è¨­å®šï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­å€¼
        let questions = JSON.parse(localStorage.getItem('quiz_questions')) || defaultQuestions;

        // Multiplayer logic
        let peer = null;
        let conn = null;
        let isHost = false;
        let isMultiplayer = false;

        // Sync State
        let myReady = false;
        let oppReady = false;

        function initHost() {
            const id = Math.floor(Math.random() * 9000 + 1000).toString(); // 4-digit ID
            peer = new Peer(id);
            peer.on('open', (id) => {
                document.getElementById('my-peer-id').innerText = id;
                document.getElementById('invite-code-display').classList.remove('hidden');
                document.getElementById('connection-status').innerText = "ç­‰å¾…å°æ‰‹åŠ å…¥...";
                document.getElementById('join-controls').classList.add('hidden');
                isHost = true;
                isMultiplayer = true;
            });
            peer.on('connection', (c) => {
                conn = c;
                setupConnection();
                document.getElementById('connection-status').innerText = "ç©å®¶å·²é€£ç·šï¼æº–å‚™é–‹å§‹";
            });
            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') initHost(); // Retry if ID collision
                else alert("é€£ç·šéŒ¯èª¤: " + err);
            });
        }

        function joinGame() {
            const targetId = document.getElementById('target-peer-id').value.trim();
            if (!targetId) return alert("è«‹è¼¸å…¥é‚€è«‹ç¢¼");

            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(targetId);
                isMultiplayer = true;
                setupConnection();
                document.getElementById('connection-status').innerText = "é€£ç·šä¸­...";
            });
            peer.on('error', (err) => alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥é‚€è«‹ç¢¼"));
        }

        function setupConnection() {
            conn.on('open', () => {
                document.getElementById('connection-status').innerText = isHost ? "å°æ‰‹å·²åŠ å…¥ï¼è«‹æŒ‰é–‹å§‹" : "å·²é€£ç·šï¼ç­‰å¾…æˆ¿ä¸»é–‹å§‹";
                if (!isHost) {
                    document.getElementById('start-game-btn').classList.add('hidden'); // Guests wait for host
                    document.getElementById('host-controls').classList.add('hidden');
                }
            });
            conn.on('data', (data) => {
                handleData(data);
            });
        }

        function handleData(data) {
            console.log("Received:", data);
            if (data.type === 'START_GAME') {
                // Sync questions from host if provided, otherwise use local (assume sync)
                // Better: Host sends questions to ensure consistency
                if (data.questions) {
                    questions = data.questions;
                }
                startGame(true); // true = remote start
            } else if (data.type === 'GAME_OVER') {
                // Opponent finished
                updateRankingUI(score, data.score);
            } else if (data.type === 'QUESTION_ANSWERED') {
                if (data.round === currentIdx) {
                    oppReady = true;
                    document.getElementById('waiting-msg').innerText = "å°æ‰‹å·²å›ç­”ï¼";
                    checkSyncNext();
                }
            }
        }

        function tryStartGame() {
            if (isMultiplayer && isHost && conn) {
                // Broadcast start
                conn.send({ type: 'START_GAME', questions: questions });
                startGame();
            } else if (isMultiplayer && !isHost) {
                // Guest waiting
            } else {
                // Single player
                startGame();
            }
        }

        let currentIdx = 0;
        let score = 0;
        let timeLeft = 100;
        let timerId = null;
        const TIME_LIMIT = 100;

        function startGame(isRemote = false) {
            if (document.getElementById('start-screen').classList.contains('hidden')) return; // Avoid double start
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentIdx >= questions.length) {
                endGame();
                return;
            }

            // Reset Sync Flags
            myReady = false;
            oppReady = false;
            document.getElementById('waiting-msg').classList.add('hidden');
            document.getElementById('options-container').classList.remove('disabled-area'); // Assuming you might add this class for disabling

            const q = questions[currentIdx];
            document.getElementById('question-text').innerText = q.q;
            document.getElementById('current-idx').innerText = currentIdx + 1;

            // é¡¯ç¤ºåœ–ç‰‡
            const imgContainer = document.getElementById('img-container');
            if (q.image && q.image.trim() !== "") {
                imgContainer.innerHTML = `<img src="${q.image}" style="max-width: 100%; max-height: 250px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">`;
                imgContainer.classList.remove('hidden');
            } else {
                imgContainer.innerHTML = '';
                imgContainer.classList.add('hidden'); // Hide if no image
            }

            // æº–å‚™ç´¢å¼•ä¸¦æ‰“äº‚
            let indices = q.a.map((_, i) => i);
            indices.sort(() => Math.random() - 0.5);

            const container = document.getElementById('options-container');
            container.innerHTML = '';

            indices.forEach((originalIndex) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = q.a[originalIndex];
                btn.dataset.originalIndex = originalIndex; // å„²å­˜åŸå§‹ç´¢å¼•ä»¥ä¾¿æ ¸å°
                btn.onclick = () => checkAnswer(originalIndex, btn);
                container.appendChild(btn);
            });

            startTimer();
        }

        function startTimer() {
            clearInterval(timerId);
            timeLeft = TIME_LIMIT;
            document.getElementById('timer-bar').style.width = '100%';
            timerId = setInterval(() => {
                timeLeft -= 1;
                document.getElementById('timer-bar').style.width = timeLeft + '%';
                if (timeLeft <= 0) {
                    checkAnswer(-1, null); // æ™‚é–“åˆ°
                }
            }, 100);
        }

        function updateScoreDisplay() {
            document.getElementById('live-score').innerText = `ç›®å‰åˆ†æ•¸ï¼š${score}`;
            if (conn && conn.open) {
                try { conn.send({ type: 'SCORE_UPDATE', score: score }); } catch (e) { }
            }
        }

        function checkAnswer(selectedOriginalIndex, selectedBtn) {
            clearInterval(timerId);
            const q = questions[currentIdx];
            const btns = document.querySelectorAll('.option-btn');

            btns.forEach(btn => btn.disabled = true);

            if (selectedOriginalIndex === q.correct) {
                if (selectedBtn) selectedBtn.classList.add('correct');
                score += Math.ceil(timeLeft / 10 * 10); // Score based on remaining time
                updateScoreDisplay();
            } else {
                if (selectedBtn) selectedBtn.classList.add('wrong');
                // æ‰¾å‡ºæ­£ç¢ºç­”æ¡ˆçš„æŒ‰éˆ•ä¸¦é¡¯ç¤º
                const correctBtn = Array.from(btns).find(btn => parseInt(btn.dataset.originalIndex) === q.correct);
                if (correctBtn) correctBtn.classList.add('correct');
            }

            // Sync Logic
            if (isMultiplayer) {
                myReady = true;
                conn.send({ type: 'QUESTION_ANSWERED', round: currentIdx });

                document.getElementById('waiting-msg').innerText = "ç­‰å¾…å°æ‰‹å›ç­”...";
                document.getElementById('waiting-msg').classList.remove('hidden');

                checkSyncNext();
            } else {
                setTimeout(nextQuestion, 1200);
            }
        }

        function checkSyncNext() {
            if (myReady && oppReady) {
                setTimeout(nextQuestion, 500); // Short delay to see status
            }
        }

        function nextQuestion() {
            currentIdx++;
            loadQuestion();
        }

        function endGame() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('score-display').innerText = `æœ€çµ‚å¾—åˆ†ï¼š${score}`;

            // Multiplayer Ranking Logic
            if (isMultiplayer && conn && conn.open) {
                conn.send({ type: 'GAME_OVER', score: score });
                document.getElementById('ranking-container').classList.remove('hidden');
                document.getElementById('rank-list').innerHTML = `
                    <div style="padding:5px; border-bottom:1px solid #ddd; font-weight:bold; color:var(--primary);">æˆ‘æ–¹: ${score} åˆ† (ç­‰å¾…å°æ‰‹æˆç¸¾...)</div>
                `;
            } else {
                document.getElementById('ranking-container').classList.add('hidden');
            }
        }

        // Helper to update ranking UI
        function updateRankingUI(myScore, oppScore) {
            const list = document.getElementById('rank-list');
            let myClass = myScore > oppScore ? "ğŸ¥‡ å† è»" : (myScore == oppScore ? "ğŸ¤ å¹³æ‰‹" : "ğŸ¥ˆ äºè»");
            let oppClass = oppScore > myScore ? "ğŸ¥‡ å† è»" : (myScore == oppScore ? "ğŸ¤ å¹³æ‰‹" : "ğŸ¥ˆ äºè»");

            // Sort
            let html = '';
            if (myScore >= oppScore) {
                html += `<div style="padding:10px; border-bottom:1px solid #ddd; font-weight:bold; color:#00b894;">${myClass} - æˆ‘æ–¹: ${myScore} åˆ†</div>`;
                html += `<div style="padding:10px; font-weight:bold; color:#d63031;">${oppClass} - å°æ‰‹: ${oppScore} åˆ†</div>`;
            } else {
                html += `<div style="padding:10px; border-bottom:1px solid #ddd; font-weight:bold; color:#d63031;">${oppClass} - å°æ‰‹: ${oppScore} åˆ†</div>`;
                html += `<div style="padding:10px; font-weight:bold; color:#00b894;">${myClass} - æˆ‘æ–¹: ${myScore} åˆ†</div>`;
            }
            list.innerHTML = html;
        }
    </script>

</body>

</html>